
import sqlite3
import logging
from notifylib.getmovies import Get_Movies
from notifylib.getseries import Get_Series


class Update:
    def __init__(self, db_file):
        self.connect = sqlite3.connect(db_file)
        self.cursor = self.connect.cursor()
        
    def movie(self):
        movie = Get_Movies(self.cursor, self.connect)
        movie.fetch_new_movies()

    def series(self):
        series = Get_Series(self.cursor, self.connect)
        all_series = series.fetch_series_data()
        for data in all_series:
            try:
                all_episodes, new_ep_number, title, current_ep_number, no_seasons = series.fetch_new_episdoes(data[0], data[1], data[2])
                if current_ep_number == 0:
                    logging.info("Adding Series episodes")
                    series.new_series_episodes(all_episodes, new_ep_number, title, no_seasons)
                else:
                    logging.info("Comparing new and old list")
                    new_episodes = compare(all_episodes)
                    #series.insert_new_epsiodes(new_episodes, new_ep_number,
                                           #title, no_seasons)
            except Exception as e:
                logging.info(e)
                continue

    def get_interval(self):
        self.cursor.execute("SELECT value FROM config WHERE key = 'update_interval'")
        time_int = self.cursor.fetchone()
        return time_int[0]

    def close(self):
        self.connect.close()


def compare(cursor, title, new_list):
    old_list = []
    cursor.execute("SELECT episode_link,episode_name from episodes where title=?",
                   (title,))
    data = cursor.fetchall()
    if data:
        for old_data in data:
            old_list.append(old_data[0])
            list_difference = set(new_list).difference(old_list)
        if len(list_difference) == 0:
            logging.info("No New episodes")
            return
        else:
            logging.info("There are the new episodes")
            return list_difference, "announce"
    else:
        logging.info("new series episodes to be added")
        return new_list
